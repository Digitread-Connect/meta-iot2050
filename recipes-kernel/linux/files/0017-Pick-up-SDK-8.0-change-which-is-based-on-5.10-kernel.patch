From 588f7ccd8f97e7d81793ff5b105c998ee8cddbb3 Mon Sep 17 00:00:00 2001
From: Su Bao Cheng <baocheng.su@siemens.com>
Date: Tue, 24 Aug 2021 11:44:45 +0800
Subject: [PATCH 17/17] Pick up SDK 8.0 change, which is based on 5.10 kernel

Signed-off-by: Su Bao Cheng <baocheng.su@siemens.com>
---
 .../boot/dts/ti/k3-am65-iot2050-pg2.dtsi      | 84 +++++++++++--------
 arch/arm64/boot/dts/ti/k3-am65-iot2050.dtsi   |  4 +-
 2 files changed, 49 insertions(+), 39 deletions(-)

diff --git a/arch/arm64/boot/dts/ti/k3-am65-iot2050-pg2.dtsi b/arch/arm64/boot/dts/ti/k3-am65-iot2050-pg2.dtsi
index f44f2cdc92d3..493dcb5fac79 100644
--- a/arch/arm64/boot/dts/ti/k3-am65-iot2050-pg2.dtsi
+++ b/arch/arm64/boot/dts/ti/k3-am65-iot2050-pg2.dtsi
@@ -11,8 +11,8 @@ / {
 	model = "SIMATIC IOT2050 Common";
 
 	aliases {
-		ethernet1 = &pruss0_emac0;
-		ethernet2 = &pruss0_emac1;
+		ethernet1 = &icssg0_emac0;
+		ethernet2 = &icssg0_emac1;
 		spi0 = &mcu_spi0;
 	};
 
@@ -64,12 +64,12 @@ rtos_ipc_memory_region: ipc-memories@a2000000 {
 	};
 
 	/* Dual Ethernet application node on PRU-ICSSG0 */
-	pruss0_eth: pruss0_eth {
+	icssg0_eth: icssg0-eth {
 		compatible = "ti,am654-icssg-prueth";
 		pinctrl-names = "default";
 		pinctrl-0 = <&icssg0_rgmii_pins_default>;
 		sram = <&msmc_ram>;
-		prus = <&pru0_0>, <&rtu0_0>, <&tx_pru0_0>, <&pru0_1>, <&rtu0_1>, <&tx_pru0_1>;
+		ti,prus = <&pru0_0>, <&rtu0_0>, <&tx_pru0_0>, <&pru0_1>, <&rtu0_1>, <&tx_pru0_1>;
 		firmware-name = "ti-pruss/am65x-sr2-pru0-prueth-fw.elf",
 				"ti-pruss/am65x-sr2-rtu0-prueth-fw.elf",
 				"ti-pruss/am65x-sr2-txpru0-prueth-fw.elf",
@@ -85,39 +85,41 @@ pruss0_eth: pruss0_eth {
 						<2>;
 		mii-g-rt = <&icssg0_mii_g_rt>;
 		mii-rt = <&icssg0_mii_rt>;
-		dma-coherent;
+		iep = <&icssg0_iep0>,  <&icssg0_iep1>;
+
+		interrupt-parent = <&icssg0_intc>;
+		interrupts = <24 0 2>, <25 1 3>;
+		interrupt-names = "tx_ts0", "tx_ts1";
+
 		dmas = <&main_udmap 0xc100>, /* egress slice 0 */
-				<&main_udmap 0xc101>, /* egress slice 0 */
-				<&main_udmap 0xc102>, /* egress slice 0 */
-				<&main_udmap 0xc103>, /* egress slice 0 */
-				<&main_udmap 0xc104>, /* egress slice 1 */
-				<&main_udmap 0xc105>, /* egress slice 1 */
-				<&main_udmap 0xc106>, /* egress slice 1 */
-				<&main_udmap 0xc107>, /* egress slice 1 */
-
-				<&main_udmap 0x4100>, /* ingress slice 0 */
-				<&main_udmap 0x4101>, /* ingress slice 1 */
-				<&main_udmap 0x4102>, /* mgmnt rsp slice 0 */
-				<&main_udmap 0x4103>; /* mgmnt rsp slice 1 */
+		       <&main_udmap 0xc101>, /* egress slice 0 */
+		       <&main_udmap 0xc102>, /* egress slice 0 */
+		       <&main_udmap 0xc103>, /* egress slice 0 */
+		       <&main_udmap 0xc104>, /* egress slice 1 */
+		       <&main_udmap 0xc105>, /* egress slice 1 */
+		       <&main_udmap 0xc106>, /* egress slice 1 */
+		       <&main_udmap 0xc107>, /* egress slice 1 */
+
+		       <&main_udmap 0x4100>, /* ingress slice 0 */
+		       <&main_udmap 0x4101>, /* ingress slice 1 */
+		       <&main_udmap 0x4102>, /* mgmnt rsp slice 0 */
+		       <&main_udmap 0x4103>; /* mgmnt rsp slice 1 */
 		dma-names = "tx0-0", "tx0-1", "tx0-2", "tx0-3",
-				"tx1-0", "tx1-1", "tx1-2", "tx1-3",
-				"rx0", "rx1",
-				"rxmgm0", "rxmgm1";
+			    "tx1-0", "tx1-1", "tx1-2", "tx1-3",
+			    "rx0", "rx1",
+			    "rxmgm0", "rxmgm1";
 
-		pruss0_emac0: ethernet-mii0 {
-			phy-handle = <&pruss0_eth0_phy>;
+		icssg0_emac0: ethernet-mii0 {
+			phy-handle = <&icssg0_phy0>;
 			phy-mode = "rgmii-rxid";
-			interrupts-extended = <&icssg0_intc 24>;
 			syscon-rgmii-delay = <&scm_conf 0x4100>;
-			iep = <&icssg0_iep0>;
 			/* Filled in by bootloader */
 			local-mac-address = [00 00 00 00 00 00];
 		};
 
-		pruss0_emac1: ethernet-mii1 {
-			phy-handle = <&pruss0_eth1_phy>;
+		icssg0_emac1: ethernet-mii1 {
+			phy-handle = <&icssg0_phy1>;
 			phy-mode = "rgmii-rxid";
-			interrupts-extended = <&icssg0_intc 25>;
 			syscon-rgmii-delay = <&scm_conf 0x4104>;
 			/* Filled in by bootloader */
 			local-mac-address = [00 00 00 00 00 00];
@@ -793,25 +795,25 @@ &icssg0_mdio {
 	#address-cells = <1>;
 	#size-cells = <0>;
 
-	pruss0_eth0_phy: ethernet-phy@0 {
+	icssg0_phy0: ethernet-phy@0 {
 		reg = <0>;
 		ti,rx-internal-delay = <DP83867_RGMIIDCTL_2_00_NS>;
 		ti,fifo-depth = <DP83867_PHYCR_FIFO_DEPTH_4_B_NIB>;
 		ti,led-sel = <DP83867_LINK_ESTABLISHED_100BTX>,
-				<DP83867_LINK_ESTABLISHED_100BTX>,
-				<DP83867_LINK_ESTABLISHED_1000BT>,
-				<DP83867_LINK_ESTABLISHED_BLINK_TRANSMIT_RECEIVE>;
+			     <DP83867_LINK_ESTABLISHED_100BTX>,
+			     <DP83867_LINK_ESTABLISHED_1000BT>,
+			     <DP83867_LINK_ESTABLISHED_BLINK_TRANSMIT_RECEIVE>;
 		ti,led-name = "led_3","led_2","led_1","led_0";
 	};
 
-	pruss0_eth1_phy: ethernet-phy@1 {
+	icssg0_phy1: ethernet-phy@1 {
 		reg = <1>;
 		ti,rx-internal-delay = <DP83867_RGMIIDCTL_2_00_NS>;
 		ti,fifo-depth = <DP83867_PHYCR_FIFO_DEPTH_4_B_NIB>;
 		ti,led-sel = <DP83867_LINK_ESTABLISHED_100BTX>,
-				<DP83867_LINK_ESTABLISHED_100BTX>,
-				<DP83867_LINK_ESTABLISHED_1000BT>,
-				<DP83867_LINK_ESTABLISHED_BLINK_TRANSMIT_RECEIVE>;
+			     <DP83867_LINK_ESTABLISHED_100BTX>,
+			     <DP83867_LINK_ESTABLISHED_1000BT>,
+			     <DP83867_LINK_ESTABLISHED_BLINK_TRANSMIT_RECEIVE>;
 		ti,led-name = "led_3","led_2","led_1","led_0";
 	};
 };
@@ -849,9 +851,17 @@ &pcie0_ep {
 
 /* Disable crypto and rng temporarily, because the HS system firmware has taken them up */
 &crypto {
-      status = "disabled";
+	status = "disabled";
 };
 
 &rng {
-      status = "disabled";
+	status = "disabled";
+};
+
+&m_can0 {
+	status = "disabled";
+};
+
+&m_can1 {
+	status = "disabled";
 };
diff --git a/arch/arm64/boot/dts/ti/k3-am65-iot2050.dtsi b/arch/arm64/boot/dts/ti/k3-am65-iot2050.dtsi
index dae196642ce5..61de18b5e428 100644
--- a/arch/arm64/boot/dts/ti/k3-am65-iot2050.dtsi
+++ b/arch/arm64/boot/dts/ti/k3-am65-iot2050.dtsi
@@ -27,7 +27,7 @@ &tx_pru2_1 {
 	status = "disabled";
 };
 
-&pruss0_eth {
+&icssg0_eth {
 	compatible = "ti,am654-icssg-prueth-sr1";
 	prus = <&pru0_0>, <&rtu0_0>, <&pru0_1>, <&rtu0_1>;
 	firmware-name = "ti-pruss/am65x-pru0-prueth-fw.elf",
@@ -40,7 +40,7 @@ &pruss0_eth {
 			      <2>;
 };
 
-&pruss0_emac1 {
+&icssg0_emac1 {
 	iep = <&icssg0_iep1>;
 };
 
-- 
2.25.1

